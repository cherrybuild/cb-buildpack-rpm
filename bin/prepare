#!/bin/bash

# fail fast
set -o errexit
set -o nounset
set -o pipefail

indent() {
  sed -u 's/^/       /'
}

scriptname=$(basename $0)
case $# in
  1) :;;
  *) echo "$scriptname: usage: $scriptname BUILD_DIR" >&2; exit 2;;
esac

build_dir="$1"
vendor_rpm_url=http://cb-misc.s3.amazonaws.com/vendor-rpm-4.11.1-amd64.tar.gz

# Basic build dependencies
echo '
autoconf
automake
bison
byacc
elfutils
flex
gcc
gcc-c++
gettext
libtool
make
patch
patchutils
pkgconfig
redhat-rpm-config
rpm-build
tar
unzip
wget
'

find_buildrequires="$(dirname $0)/yum-printbuilddep -q"
if [ -f /etc/redhat-release ]
then
  case $(awk '{print $3}' < etc/redhat-release) in
    5.*)
      cat <<EOT >$HOME/.rpmmacros
%centos_version 505
%dist .el5
%rhel 5
EOT
      mkdir -p "$build_dir"/.heroku
      curl -fsSL $vendor_rpm_url | tar -C "$build_dir"/.heroku -xzf -
      find_buildrequires="$build_dir/.heroku/vendor/bin/rpmspec -q --buildrequires"
      ;;
    6.*)
      cat <<EOT >$HOME/.rpmmacros
%centos_version 600
EOT
      ;;
  esac
fi

if ls $build_dir/*.spec >/dev/null 2>&1
then
  $find_buildrequires $build_dir/*.spec | awk '{print $1}'
elif ls $build_dir/*.spec.in >/dev/null 2>&1
then
  spec_in=$(echo $build_dir/*.spec.in)
  spec=$(echo $spec_in | sed 's/\.in$//')
  parse_configure_ac=$(dirname $0)/parse-configure-ac
  expand_specfile_in=$(dirname $0)/expand-specfile-in

  package_name=$($parse_configure_ac name < $build_dir/configure.ac)
  package_version=$($parse_configure_ac version < $build_dir/configure.ac)

  $expand_specfile_in $package_name $package_version < $spec_in > $spec

  $find_buildrequires $spec | awk '{print $1}'
fi
